class NotificationManager{static TYPES={ANNIVERSARY:"anniversary",MEMORY:"memory",CALENDAR:"calendar",FIGHT:"fight"};constructor(){this.notifications=[],this.hasPermission=!1,this.init()}async init(){try{var t;"Notification"in window&&(t=await Notification.requestPermission(),this.hasPermission="granted"===t),this.loadSettings(),this.startChecking()}catch(t){console.error("通知初始化失败:",t)}}loadSettings(){var t=localStorage.getItem("notificationSettings");t?this.settings=JSON.parse(t):(this.settings={enabled:!0,types:{[this.TYPES.ANNIVERSARY]:!0,[this.TYPES.MEMORY]:!0,[this.TYPES.CALENDAR]:!0,[this.TYPES.FIGHT]:!0},advanceTime:{days:1,hours:0}},this.saveSettings())}saveSettings(){localStorage.setItem("notificationSettings",JSON.stringify(this.settings))}startChecking(){setInterval(()=>this.checkNotifications(),36e5),this.checkNotifications()}async checkNotifications(){var t;this.settings.enabled&&this.hasPermission&&(t=new Date,this.getUpcomingEvents(t).forEach(t=>{this.notifications.includes(t.id)||(this.showNotification(t),this.notifications.push(t.id))}),this.cleanupNotifications(t))}getUpcomingEvents(t){var i=[],e=new Date(t.getTime()+this.getAdvanceTime()),s=this.getNextAnniversary(t),s=(s.time<=e&&i.push({id:"anniversary_"+s.time,type:this.TYPES.ANNIVERSARY,title:"纪念日提醒",message:"距离下一个纪念日还有"+this.formatTimeDistance(t,s.time),time:s.time}),this.getCalendarEvents(t,e));return i.push(...s),i}getNextAnniversary(t){var i=new Date("2024-01-29"),e=t.getFullYear(),i=new Date(e,i.getMonth(),i.getDate());return i<t&&i.setFullYear(e+1),{time:i,type:"monthly"}}getCalendarEvents(s,n){let a=[];var t=JSON.parse(localStorage.getItem("calendarEvents")||"{}");return Object.entries(t).forEach(([i,t])=>{let e=new Date(i);e>s&&e<=n&&t.forEach(t=>{a.push({id:`calendar_${i}_`+t.timestamp,type:this.TYPES.CALENDAR,title:t.title,message:"即将到来的事件："+t.title,time:e})})}),a}getAdvanceTime(){return 36e5*(24*this.settings.advanceTime.days+this.settings.advanceTime.hours)}formatTimeDistance(t,i){i-=t,t=Math.floor(i/864e5),i=Math.floor(i%864e5/36e5);let e="";return 0<t&&(e+=t+"天"),0<i&&(e+=i+"小时"),e}showNotification(t){this.hasPermission&&(new Notification(t.title,{body:t.message,icon:"/images/icon.png",badge:"/images/badge.png",tag:t.id,renotify:!0}).onclick=()=>{window.focus(),this.handleNotificationClick(t)})}handleNotificationClick(t){switch(t.type){case this.TYPES.ANNIVERSARY:window.location.href="/";break;case this.TYPES.CALENDAR:window.location.href="/calendar.html"}}cleanupNotifications(i){this.notifications=this.notifications.filter(t=>{var[,t]=t.split("_"),t=new Date(t);return i<t})}enableNotifications(t){this.settings.enabled=t,this.saveSettings()}setTypeEnabled(t,i){t in this.settings.types&&(this.settings.types[t]=i,this.saveSettings())}setAdvanceTime(t,i){this.settings.advanceTime={days:t,hours:i},this.saveSettings()}}document.addEventListener("DOMContentLoaded",()=>{window.notificationManager=new NotificationManager});